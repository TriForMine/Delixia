"use strict";(self.webpackChunkdelixia=self.webpackChunkdelixia||[]).push([["3370"],{76680:function(t,e,s){s.d(e,{m:()=>r});var i=s(709),n=s(54520),o=s(12737),a=s(14581);class r extends n.Pd{constructor(t,e){super(t,e,3),this._analyzer=null,this._newestInstance=null,this._outBus=null,this._privateInstances=new Set,this._state=1,this._instances=this._privateInstances,this.onEndedObservable=new i.y$,this._onInstanceEnded=t=>{this._newestInstance===t&&(this._newestInstance=null),this._privateInstances.delete(t),0===this._instances.size&&(this._state=1,this.onEndedObservable.notifyObservers(this))},this._onOutBusDisposed=()=>{this.outBus=null}}get analyzer(){return this._analyzer??(this._analyzer=new a.fG(this._subGraph))}get autoplay(){return this._options.autoplay}get currentTime(){let t=this._getNewestInstance();return t?t.currentTime:0}set currentTime(t){this.startOffset=t;let e=this._getNewestInstance();e&&(e.currentTime=t)}get loop(){return this._options.loop}set loop(t){this._options.loop=t}get maxInstances(){return this._options.maxInstances}set maxInstances(t){this._options.maxInstances=t}get outBus(){return this._outBus}set outBus(t){if(this._outBus!==t){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw Error("Disconnect failed");if(this._outBus=t,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw Error("Connect failed")}}get startOffset(){return this._options.startOffset}set startOffset(t){this._options.startOffset=t}get state(){return this._state}get volume(){return(0,o.gB)(this._subGraph,"volume")}set volume(t){let e=(0,o.nP)(this._subGraph);if(!e)throw Error("No volume subnode");e.volume=t}dispose(){super.dispose(),this.stop(),this._analyzer?.dispose(),this._analyzer=null,this._newestInstance=null,this._outBus=null,this._privateInstances.clear(),this.onEndedObservable.clear()}pause(){let t=this._instances.values();for(let e=t.next();!e.done;e=t.next())e.value.pause();this._state=5}resume(){if(5!==this._state)return;let t=this._instances.values();for(let e=t.next();!e.done;e=t.next())e.value.resume();this._state=3}_beforePlay(t){if(5===this.state&&this._instances.size>0){this.resume();return}t.onEndedObservable.addOnce(this._onInstanceEnded),this._privateInstances.add(t),this._newestInstance=t}_afterPlay(t){this._state=t.state}_getNewestInstance(){if(0===this._instances.size)return null;if(!this._newestInstance){let t=this._instances.values();for(let e=t.next();!e.done;e=t.next())this._newestInstance=e.value}return this._newestInstance}_setState(t){this._state=t}_stopExcessInstances(){if(this.maxInstances<1/0){let t=Array.from(this._instances).filter(t=>3===t.state).length-this.maxInstances,e=this._instances.values();for(let s=0;s<t;s++)e.next().value.stop()}}}},92829:function(t,e,s){s.d(e,{V:()=>o});var i=s(709),n=s(54520);class o extends n.mC{constructor(t){super(t.engine,2),this._state=1,this.onEndedObservable=new i.y$,this.onErrorObservable=new i.y$,this.onStateChangedObservable=new i.y$,this._sound=t}get state(){return this._state}dispose(){super.dispose(),this.stop(),this.onEndedObservable.clear(),this.onStateChangedObservable.clear()}_setState(t){this._state!==t&&(this._state=t,this.onStateChangedObservable.notifyObservers(this))}}},75463:function(t,e,s){s.d(e,{F:()=>n,R:()=>i});let i=RegExp("\\.(\\w{3,4})($|\\?)");function n(t){return t.replace(/#/gm,"%23")}},66709:function(t,e,s){s.r(e),s.d(e,{_WebAudioStaticSoundBuffer:()=>c,_WebAudioStaticSound:()=>p});var i=s(76680);class n extends i.m{constructor(t,e){super(t,e)}get duration(){return this._options.duration}set duration(t){this._options.duration=t}get loopStart(){return this._options.loopStart}set loopStart(t){this._options.loopStart=t}get loopEnd(){return this._options.loopEnd}set loopEnd(t){this._options.loopEnd=t}get pitch(){return this._options.pitch}set pitch(t){this._options.pitch=t;let e=this._instances.values();for(let s=e.next();!s.done;s=e.next())s.value.pitch=t}get playbackRate(){return this._options.playbackRate}set playbackRate(t){this._options.playbackRate=t;let e=this._instances.values();for(let s=e.next();!s.done;s=e.next())s.value.playbackRate=t}play(t={}){if(5===this.state){this.resume();return}t.duration??(t.duration=this.duration),t.loop??(t.loop=this.loop),t.loopStart??(t.loopStart=this.loopStart),t.loopEnd??(t.loopEnd=this.loopEnd),t.startOffset??(t.startOffset=this.startOffset),t.volume??(t.volume=1),t.waitTime??(t.waitTime=0);let e=this._createInstance();this._beforePlay(e),e.play(t),this._afterPlay(e),this._stopExcessInstances()}stop(t={}){if(t.waitTime&&0<t.waitTime?this._setState(0):this._setState(1),this._instances)for(let e of Array.from(this._instances))e.stop(t)}}class o{constructor(t){this.engine=t}}var a=s(92829);class r extends a.V{}var h=s(61934),u=s(78220),_=s(75463),l=s(60419),d=s(7701);class p extends n{constructor(t,e,s){super(t,e),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,"boolean"==typeof s.spatialAutoUpdate&&(this._spatialAutoUpdate=s.spatialAutoUpdate),"number"==typeof s.spatialMinUpdateTime&&(this._spatialMinUpdateTime=s.spatialMinUpdateTime),this._options={autoplay:s.autoplay??!1,duration:s.duration??0,loop:s.loop??!1,loopEnd:s.loopEnd??0,loopStart:s.loopStart??0,maxInstances:s.maxInstances??1/0,pitch:s.pitch??0,playbackRate:s.playbackRate??1,startOffset:s.startOffset??0},this._subGraph=new p._SubGraph(this)}async _init(t,e){this._audioContext=this.engine._audioContext,t instanceof c?this._buffer=t:("string"==typeof t||Array.isArray(t)||t instanceof ArrayBuffer||t instanceof AudioBuffer)&&(this._buffer=await this.engine.createSoundBufferAsync(t,e)),e.outBus?this.outBus=e.outBus:(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.init(e),(0,h.xe)(e)&&this._initSpatialProperty(),e.autoplay&&this.play(),this.engine._addNode(this)}get buffer(){return this._buffer}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new u.D(this._subGraph))}dispose(){super.dispose(),this._spatial?.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return"_WebAudioStaticSound"}_createInstance(){return new f(this,this._options)}_connect(t){return!!super._connect(t)&&(t._inNode&&this._outNode?.connect(t._inNode),!0)}_disconnect(t){return!!super._disconnect(t)&&(t._inNode&&this._outNode?.disconnect(t._inNode),!0)}_initSpatialProperty(){return this._spatial||(this._spatial=new d.u(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}}p._SubGraph=class extends l.C{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};class c extends o{constructor(t){super(t)}async _init(t,e){t instanceof AudioBuffer?this._audioBuffer=t:"string"==typeof t?await this._initFromUrl(t):Array.isArray(t)?await this._initFromUrls(t,e.skipCodecCheck??!1):t instanceof ArrayBuffer&&await this._initFromArrayBuffer(t)}get channelCount(){return this._audioBuffer.numberOfChannels}get duration(){return this._audioBuffer.duration}get length(){return this._audioBuffer.length}get sampleRate(){return this._audioBuffer.sampleRate}async _initFromArrayBuffer(t){this._audioBuffer=await this.engine._audioContext.decodeAudioData(t)}async _initFromUrl(t){t=(0,_.F)(t),await this._initFromArrayBuffer(await (await fetch(t)).arrayBuffer())}async _initFromUrls(t,e){for(let s of t){if(e)await this._initFromUrl(s);else{let t=s.match(_.R),e=t?.at(1);if(e&&this.engine.isFormatValid(e))try{await this._initFromUrl(s)}catch(t){e&&0<e.length&&this.engine.flagInvalidFormat(e)}}if(this._audioBuffer)break}}}class f extends r{constructor(t,e){super(t),this._enginePlayTime=0,this._enginePauseTime=0,this._sourceNode=null,this._onEnded=()=>{this._enginePlayTime=0,this.onEndedObservable.notifyObservers(this),this._deinitSourceNode()},this._onEngineStateChanged=()=>{"running"===this.engine.state&&(this._options.loop&&2===this.state&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._options=e,this._volumeNode=new GainNode(t._audioContext),this._initSourceNode()}get currentTime(){if(1===this._state)return 0;let t=5===this._state?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+t+this._options.startOffset}set currentTime(t){let e=2===this._state||3===this._state;e&&(this.stop(),this._deinitSourceNode()),this._options.startOffset=t,e&&this.play()}get _outNode(){return this._volumeNode}set pitch(t){this._sourceNode&&this.engine._setAudioParam(this._sourceNode.detune,t)}set playbackRate(t){this._sourceNode&&this.engine._setAudioParam(this._sourceNode.playbackRate,t)}get startTime(){return 1===this._state?0:this._enginePlayTime}dispose(){super.dispose(),this._sourceNode=null,this.stop(),this._deinitSourceNode(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}getClassName(){return"_WebAudioStaticSoundInstance"}play(t={}){if(3===this._state)return;void 0!==t.duration&&(this._options.duration=t.duration),void 0!==t.loop&&(this._options.loop=t.loop),void 0!==t.loopStart&&(this._options.loopStart=t.loopStart),void 0!==t.loopEnd&&(this._options.loopEnd=t.loopEnd),void 0!==t.startOffset&&(this._options.startOffset=t.startOffset);let e=this._options.startOffset;5===this._state&&(e+=this.currentTime,e%=this._sound.buffer.duration),this._enginePlayTime=this.engine.currentTime+(t.waitTime??0),this._volumeNode.gain.value=t.volume??1,this._initSourceNode(),"running"===this.engine.state?(this._setState(3),this._sourceNode?.start(this._enginePlayTime,e,this._options.duration>0?this._options.duration:void 0)):this._options.loop&&(this._setState(2),this.engine.stateChangedObservable.add(this._onEngineStateChanged))}pause(){5!==this._state&&(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._sourceNode?.stop(),this._deinitSourceNode())}resume(){5===this._state&&this.play()}stop(t={}){if(1===this._state)return;this._setState(1);let e=this.engine.currentTime+(t.waitTime??0);this._sourceNode?.stop(e),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}_connect(t){return!!super._connect(t)&&(t instanceof p&&t._inNode&&this._outNode?.connect(t._inNode),!0)}_disconnect(t){return!!super._disconnect(t)&&(t instanceof p&&t._inNode&&this._outNode?.disconnect(t._inNode),!0)}_deinitSourceNode(){if(this._sourceNode){if(!this._disconnect(this._sound))throw Error("Disconnect failed");this._sourceNode.disconnect(this._volumeNode),this._sourceNode.removeEventListener("ended",this._onEnded),this._sourceNode=null}}_initSourceNode(){if(!this._sourceNode&&(this._sourceNode=new AudioBufferSourceNode(this._sound._audioContext,{buffer:this._sound.buffer._audioBuffer}),this._sourceNode.addEventListener("ended",this._onEnded,{once:!0}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound)))throw Error("Connect failed");let t=this._sourceNode;t.detune.value=this._sound.pitch,t.loop=this._options.loop,t.loopEnd=this._options.loopEnd,t.loopStart=this._options.loopStart,t.playbackRate.value=this._sound.playbackRate}}}}]);